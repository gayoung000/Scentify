stages:
  - build
  - deploy

# 환경 변수 설정
variables:
  MAVEN_CLI_OPTS: "-s settings.xml --batch-mode"
  AWS_S3_BUCKET: "scentify"
  AWS_REGION: "ap-northeast-2"
  EC2_USER: "ubuntu"
  EC2_HOST: "3.38.99.86"

cache:
  paths:
    - .m2\repository\

# 1️⃣ Maven 빌드 
build:
  stage: build
  tags:
    - backend
  script:
    - 'echo Current directory: %cd%'
    - dir BackEnd\scentify
    - echo Maven build starts.
    - mvn clean package -DskipTests -X -e -f BackEnd\scentify\pom.xml
    - if not exist target\deploy mkdir target\deploy
    - copy /Y BackEnd\scentify\target\*.jar target\deploy\app.jar
  artifacts:
    paths:
      - target\deploy\app.jar
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH == "BE/develop"'

# 2️⃣ S3 업로드 
upload-to-s3:
  stage: deploy
  tags:
    - backend
  script:
    - echo S3 upload starts...
    - aws configure set aws_access_key_id %AWS_ACCESS_KEY_ID%
    - aws configure set aws_secret_access_key %AWS_SECRET_ACCESS_KEY%
    - aws configure set default.region %AWS_REGION%
    - aws s3 cp target\deploy\app.jar s3://%AWS_S3_BUCKET%/app.jar
  rules:
    - if: '$CI_COMMIT_BRANCH == "BE/develop"'
