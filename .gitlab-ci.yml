stages:
  - build
  - deploy

# ÌôòÍ≤Ω Î≥ÄÏàò ÏÑ§Ï†ï
variables:
  MAVEN_CLI_OPTS: "-s settings.xml --batch-mode"
  AWS_S3_BUCKET: "scentify"
  AWS_REGION: "ap-northeast-2"
  EC2_USER: "ubuntu"
  EC2_HOST: "3.38.99.86"

cache:
  paths:
    - .m2/repository/

# 1Ô∏è‚É£ Maven ÎπåÎìú
build:
  stage: build
  image: maven:3.8.7-openjdk-17
  script:
    - echo "üõ†Ô∏è Maven ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú Ï§ë..."
    - mvn clean package -DskipTests
    - mkdir -p target/deploy
    - cp target/*.jar target/deploy/app.jar
  artifacts:
    paths:
      - target/deploy/app.jar
    expire_in: 1 hour
  rules:
    - if: $CI_COMMIT_BRANCH == "BE/develop"

# 2Ô∏è‚É£ S3 ÏóÖÎ°úÎìú
upload-to-s3:
  stage: deploy
  image: amazon/aws-cli
  script:
    - echo "üì§ S3 ÏóÖÎ°úÎìú ÏãúÏûë..."
    - export AWS_ACCESS_KEY_ID="${AWS_ACCESS_KEY_ID}"
    - export AWS_SECRET_ACCESS_KEY="${AWS_SECRET_ACCESS_KEY}"
    - aws s3 cp target/deploy/app.jar s3://$AWS_S3_BUCKET/app.jar --region $AWS_REGION
  rules:
    - if: $CI_COMMIT_BRANCH == "BE/develop"

# 3Ô∏è‚É£ EC2Ïóê Î∞∞Ìè¨
deploy-to-ec2:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache openssh
  script:
    - echo "üîê EC2 Ï†ëÏÜç & Î∞∞Ìè¨ ÏßÑÌñâ..."
    - printf "%s" "$SSH_PRIVATE_KEY" > key.pem  # SSH Key Ï†ÄÏû• Î∞©Ïãù Í∞úÏÑ†
    - chmod 600 key.pem
    - |
      ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST << EOF
      set -e
      echo "üîÑ Í∏∞Ï°¥ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï§ëÏßÄ..."
      if command -v lsof > /dev/null; then
        PID=$(lsof -t -i:8080)
      else
        PID=$(ps aux | grep java | grep -v grep | awk '{print $2}')
      fi
      if [ -n "$PID" ]; then
        echo "üî¥ Í∏∞Ï°¥ ÌîÑÎ°úÏÑ∏Ïä§ Ï¢ÖÎ£å (PID: $PID)"
        kill -9 $PID
      fi
      echo "üì• S3ÏóêÏÑú ÏµúÏã† JAR Îã§Ïö¥Î°úÎìú..."
      aws s3 cp s3://$AWS_S3_BUCKET/app.jar ~/app/app.jar
      echo "üöÄ ÏÉà Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ïã§Ìñâ..."
      nohup java -jar ~/app/app.jar > ~/app/app.log 2>&1 &
      disown
      exit
      EOF
  rules:
    - if: $CI_COMMIT_BRANCH == "BE/develop"
