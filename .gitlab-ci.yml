stages:
  - build
  - deploy

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
variables:
  MAVEN_CLI_OPTS: "-s settings.xml --batch-mode"
  AWS_S3_BUCKET: "scentify"
  AWS_REGION: "ap-northeast-2"
  EC2_USER: "ubuntu"
  EC2_HOST: "3.38.99.86"

cache:
  paths:
    - .m2/repository/

# 1ï¸âƒ£ Maven ë¹Œë“œ
build:
  stage: build
  image: maven:3.8.7-openjdk-17
  script:
    - echo "ðŸ› ï¸ Maven í”„ë¡œì íŠ¸ ë¹Œë“œ ì¤‘..."
    - mvn clean package -DskipTests
    - mkdir -p target/deploy
    - cp target/*.jar target/deploy/app.jar
  artifacts:
    paths:
      - target/deploy/app.jar
    expire_in: 1 hour

# 2ï¸âƒ£ S3 ì—…ë¡œë“œ
upload-to-s3:
  stage: deploy
  image: amazon/aws-cli
  script:
    - echo "ðŸ“¤ S3 ì—…ë¡œë“œ ì‹œìž‘..."
    - aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
    - aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
    - aws s3 cp target/deploy/app.jar s3://$AWS_S3_BUCKET/app.jar --region $AWS_REGION
  only:
    - BE/develop

# 3ï¸âƒ£ EC2ì— ë°°í¬
deploy-to-ec2:
  stage: deploy
  image: alpine
  before_script:
    - apk add --no-cache openssh
  script:
    - echo "ðŸ” EC2 ì ‘ì† & ë°°í¬ ì§„í–‰..."
    - echo "$SSH_PRIVATE_KEY" > key.pem
    - chmod 600 key.pem
    - ssh -o StrictHostKeyChecking=no -i key.pem $EC2_USER@$EC2_HOST << EOF
        set -e
        echo "ðŸ”„ ê¸°ì¡´ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤‘ì§€..."
        PID=\$(lsof -t -i:8080)
        if [ -n "\$PID" ]; then
          kill -9 \$PID
        fi
        echo "ðŸ“¥ S3ì—ì„œ ìµœì‹  JAR ë‹¤ìš´ë¡œë“œ..."
        aws s3 cp s3://$AWS_S3_BUCKET/app.jar ~/app/app.jar
        echo "ðŸš€ ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰..."
        nohup java -jar ~/app/app.jar > ~/app/app.log 2>&1 &
        disown
        exit
      EOF
  only:
    - BE/develop
